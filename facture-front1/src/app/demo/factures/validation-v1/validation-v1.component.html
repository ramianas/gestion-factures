<!-- Fichier: facture-front1/src/app/demo/factures/validation-v1/validation-v1.component.html -->

<div class="validation-v1-container">
  <!-- En-tête -->
  <div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="page-title">
          <i class="fas fa-check-circle me-2"></i>
          Validation Niveau 1
        </h2>
        <p class="page-subtitle">Factures en attente de votre validation ({{ currentUser?.nomComplet }})</p>
      </div>
      <div class="header-actions">
        <button
          type="button"
          class="btn btn-outline-secondary"
          (click)="actualiser()"
          [disabled]="isLoading">
          <i class="fas fa-sync-alt me-1" [class.fa-spin]="isLoading"></i>
          Actualiser
        </button>
      </div>
    </div>
  </div>

  <!-- Messages d'erreur -->
  <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ errorMessage }}
    <button type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Fermer">&times;</button>
  </div>

  <!-- Messages de succès -->
  <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle me-2"></i>
    {{ successMessage }}
    <button type="button" class="btn-close" (click)="successMessage = ''" aria-label="Fermer">&times;</button>
  </div>

  <!-- Statistiques rapides -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stat-card urgent">
        <div class="stat-icon bg-danger">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-content">
          <h3>{{ stats.urgent }}</h3>
          <p>Urgentes</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-icon bg-warning">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
          <h3>{{ stats.enAttente }}</h3>
          <p>En attente</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-icon bg-success">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
          <h3>{{ stats.validees }}</h3>
          <p>Validées</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-icon bg-secondary">
          <i class="fas fa-times-circle"></i>
        </div>
        <div class="stat-content">
          <h3>{{ stats.rejetees }}</h3>
          <p>Rejetées</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Liste des factures en attente -->
  <app-card cardTitle="Factures en attente de validation V1" [showContent]="true">
    <ng-template #headerTitleTemplate>
      <i class="fas fa-list-check me-2"></i>
    </ng-template>

    <!-- État de chargement -->
    <div *ngIf="isLoading" class="loading-state text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Chargement...</span>
      </div>
      <p class="mt-3">Chargement des factures...</p>
    </div>

    <!-- Aucune facture -->
    <div *ngIf="!isLoading && facturesEnAttente.length === 0" class="empty-state text-center py-5">
      <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
      <h5>Aucune facture en attente</h5>
      <p class="text-muted">
        Toutes les factures qui vous sont assignées ont été traitées.
      </p>
      <button type="button" class="btn btn-outline-primary mt-2" (click)="actualiser()">
        <i class="fas fa-sync-alt me-1"></i>
        Vérifier de nouveau
      </button>
    </div>

    <!-- Tableau des factures -->
    <div *ngIf="!isLoading && facturesEnAttente.length > 0" class="table-responsive">
      <table class="table table-hover">
        <thead class="table-light">
        <tr>
          <th class="text-center">Urgence</th>
          <th>Numéro</th>
          <th>Fournisseur</th>
          <th class="text-end">Montant TTC</th>
          <th>Date Création</th>
          <th>Échéance</th>
          <th>Créateur</th>
          <th class="text-center">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let facture of facturesEnAttente; trackBy: trackByFactureId"
            [class.table-warning]="isFactureUrgente(facture)"
            [class.table-danger]="isFactureEnRetard(facture)">

          <!-- Urgence -->
          <td class="text-center">
            <i [class]="getUrgenceIcon(facture)"
               [ngClass]="getUrgenceClass(facture)"
               [attr.title]="getUrgenceTexte(facture)"></i>
          </td>

          <!-- Numéro -->
          <td>
            <strong class="facture-numero">{{ facture.numero }}</strong>
          </td>

          <!-- Fournisseur -->
          <td>
            <div class="fournisseur-info">
              <div class="nom">{{ facture.nomFournisseur }}</div>
              <small class="text-muted" *ngIf="facture.designation">
                {{ facture.designation.length > 50 ? (facture.designation | slice:0:50) + '...' : facture.designation }}
              </small>
            </div>
          </td>

          <!-- Montant -->
          <td class="text-end">
            <strong class="text-primary montant">{{ formatMontant(facture.montantTTC || 0) }}</strong>
            <br>
            <small class="text-muted">HT: {{ formatMontant(facture.montantHT || 0) }}</small>
          </td>

          <!-- Date Création -->
          <td>
            <div class="date-info">
              {{ formatDate(facture.dateFacture || '') }}
              <br>
              <small class="text-muted">{{ formatDateDiff(facture.dateCreation || '') }}</small>
            </div>
          </td>

          <!-- Échéance -->
          <td>
            <div class="echeance-info" [ngClass]="getUrgenceClass(facture)">
              <div class="date">{{ formatDate(facture.dateEcheance || '') }}</div>
              <small class="urgence-text">{{ getUrgenceTexte(facture) }}</small>
            </div>
          </td>

          <!-- Créateur -->
          <td>
            <div class="createur-info">
              <small class="nom">{{ facture.createurNom }}</small>
              <br>
              <small class="text-muted">Créée le {{ formatDate(facture.dateCreation || '') }}</small>
            </div>
          </td>

          <!-- Actions -->
          <td class="text-center">
            <div class="btn-group" role="group" aria-label="Actions de validation">
              <!-- Voir détails -->
              <button
                type="button"
                class="btn btn-sm btn-outline-info"
                (click)="voirDetailsFacture(facture)"
                [attr.title]="'Voir les détails de la facture ' + facture.numero">
                <i class="fas fa-eye"></i>
              </button>

              <!-- Approuver -->
              <button
                type="button"
                class="btn btn-sm btn-success"
                (click)="ouvrirModalValidation(facture, 'approve')"
                [attr.title]="'Approuver la facture ' + facture.numero">
                <i class="fas fa-check"></i>
              </button>

              <!-- Rejeter -->
              <button
                type="button"
                class="btn btn-sm btn-danger"
                (click)="ouvrirModalValidation(facture, 'reject')"
                [attr.title]="'Rejeter la facture ' + facture.numero">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </app-card>
</div>

<!-- Modal de validation -->
<div class="modal fade"
     [class.show]="showValidationModal"
     [style.display]="showValidationModal ? 'block' : 'none'"
     tabindex="-1"
     role="dialog"
     aria-labelledby="validationModalLabel"
     aria-hidden="!showValidationModal"
     *ngIf="showValidationModal">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">

      <!-- En-tête du modal -->
      <div class="modal-header" [ngClass]="{
        'bg-success text-white': modalType === 'approve',
        'bg-danger text-white': modalType === 'reject'
      }">
        <h5 class="modal-title" id="validationModalLabel">
          <i class="fas" [ngClass]="{
            'fa-check-circle': modalType === 'approve',
            'fa-times-circle': modalType === 'reject'
          }" class="me-2"></i>
          {{ modalType === 'approve' ? 'Approuver' : 'Rejeter' }} la facture
        </h5>
        <button type="button"
                class="btn-close btn-close-white"
                (click)="fermerModal()"
                aria-label="Fermer">
        </button>
      </div>

      <!-- Corps du modal -->
      <div class="modal-body" *ngIf="factureSelected">

        <!-- Informations de la facture -->
        <div class="facture-info mb-4">
          <h6 class="section-title">
            <i class="fas fa-file-invoice me-2"></i>
            Informations de la facture
          </h6>
          <div class="info-grid">
            <div class="row">
              <div class="col-md-6">
                <div class="info-item">
                  <label>Numéro:</label>
                  <span class="value">{{ factureSelected.numero }}</span>
                </div>
                <div class="info-item">
                  <label>Fournisseur:</label>
                  <span class="value">{{ factureSelected.nomFournisseur }}</span>
                </div>
                <div class="info-item">
                  <label>Montant TTC:</label>
                  <span class="value text-primary">{{ formatMontant(factureSelected.montantTTC || 0) }}</span>
                </div>
              </div>
              <div class="col-md-6">
                <div class="info-item">
                  <label>Date facture:</label>
                  <span class="value">{{ formatDate(factureSelected.dateFacture || '') }}</span>
                </div>
                <div class="info-item">
                  <label>Échéance:</label>
                  <span class="value" [ngClass]="getUrgenceClass(factureSelected)">
                    {{ formatDate(factureSelected.dateEcheance || '') }}
                  </span>
                </div>
                <div class="info-item">
                  <label>Créateur:</label>
                  <span class="value">{{ factureSelected.createurNom }}</span>
                </div>
              </div>
            </div>

            <div class="row mt-3" *ngIf="factureSelected.designation">
              <div class="col-12">
                <div class="info-item">
                  <label>Désignation:</label>
                  <span class="value">{{ factureSelected.designation }}</span>
                </div>
              </div>
            </div>

            <div class="row mt-3" *ngIf="factureSelected.commentaires">
              <div class="col-12">
                <div class="info-item">
                  <label>Commentaires du créateur:</label>
                  <span class="value text-muted">{{ factureSelected.commentaires }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Messages d'erreur/succès dans le modal -->
        <div *ngIf="errorMessage" class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          {{ errorMessage }}
        </div>

        <div *ngIf="successMessage" class="alert alert-success">
          <i class="fas fa-check-circle me-2"></i>
          {{ successMessage }}
        </div>

        <!-- Formulaire de validation -->
        <form [formGroup]="validationForm" (ngSubmit)="validerFacture()" *ngIf="!successMessage">

          <!-- Decision (caché car déjà déterminée par le bouton cliqué) -->
          <input type="hidden" formControlName="decision">

          <!-- Commentaire de validation -->
          <div class="mb-3">
            <label for="commentaire" class="form-label required">
              <i class="fas" [ngClass]="{
                'fa-comment-check': modalType === 'approve',
                'fa-comment-times': modalType === 'reject'
              }" class="me-2"></i>
              {{ modalType === 'approve' ? 'Commentaire de validation' : 'Motif de rejet' }}
            </label>
            <textarea
              id="commentaire"
              class="form-control"
              formControlName="commentaire"
              rows="4"
              [placeholder]="modalType === 'approve'
                ? 'Exemple: Facture conforme, montants vérifiés, bon pour validation niveau 2...'
                : 'Exemple: Documents manquants, montant incorrect, fournisseur non référencé...'"
              [class.is-invalid]="validationForm.get('commentaire')?.invalid && validationForm.get('commentaire')?.touched">
            </textarea>

            <!-- Messages d'erreur pour le commentaire -->
            <div class="invalid-feedback" *ngIf="validationForm.get('commentaire')?.invalid && validationForm.get('commentaire')?.touched">
              <div *ngIf="validationForm.get('commentaire')?.errors?.['required']">
                Le commentaire est obligatoire pour valider votre décision
              </div>
              <div *ngIf="validationForm.get('commentaire')?.errors?.['minlength']">
                Le commentaire doit contenir au moins 10 caractères
              </div>
              <div *ngIf="validationForm.get('commentaire')?.errors?.['maxlength']">
                Le commentaire ne peut pas dépasser 500 caractères
              </div>
            </div>

            <!-- Compteur de caractères et aide -->
            <div class="form-text d-flex justify-content-between">
              <small class="text-muted">
                {{ modalType === 'approve'
                ? 'Précisez les éléments vérifiés et validés'
                : 'Détaillez les motifs du rejet pour le créateur'
                }}
              </small>
              <small [class]="(validationForm.get('commentaire')?.value || '').length > 450 ? 'text-warning' : 'text-muted'">
                {{ (validationForm.get('commentaire')?.value || '').length }}/500 caractères
              </small>
            </div>
          </div>
        </form>

        <!-- Message de confirmation après validation réussie -->
        <div *ngIf="successMessage" class="text-center py-3">
          <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
          <p class="mb-0">La validation sera fermée automatiquement...</p>
        </div>
      </div>

      <!-- Pied du modal -->
      <div class="modal-footer" *ngIf="!successMessage">
        <button type="button"
                class="btn btn-secondary"
                (click)="fermerModal()"
                [disabled]="isProcessing">
          <i class="fas fa-times me-1"></i>
          Annuler
        </button>

        <button
          type="button"
          class="btn validation-btn"
          [ngClass]="{
            'btn-success': modalType === 'approve',
            'btn-danger': modalType === 'reject'
          }"
          (click)="validerFacture()"
          [disabled]="validationForm.invalid || isProcessing">

          <span *ngIf="isProcessing" class="spinner-border spinner-border-sm me-2" role="status"></span>
          <i *ngIf="!isProcessing" class="fas" [ngClass]="{
            'fa-check': modalType === 'approve',
            'fa-times': modalType === 'reject'
          }" class="me-2"></i>

          <span *ngIf="!isProcessing">
            {{ modalType === 'approve' ? 'Confirmer l\'approbation' : 'Confirmer le rejet' }}
          </span>
          <span *ngIf="isProcessing">
            {{ modalType === 'approve' ? 'Approbation en cours...' : 'Rejet en cours...' }}
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Overlay du modal -->
<div class="modal-backdrop fade"
     [class.show]="showValidationModal"
     *ngIf="showValidationModal"
     (click)="fermerModal()">
</div>
